#!/usr/bin/env python3
"""
Linux Persistence Checker
Detects common persistence mechanisms and backdoors
For authorized security testing only
"""

import os
import sys
import subprocess
import re
from pathlib import Path
from typing import List, Dict
import argparse
import hashlib

# Colors
class C:
    R = '\033[91m'
    Y = '\033[93m'
    G = '\033[92m'
    B = '\033[94m'
    M = '\033[95m'
    C = '\033[96m'
    E = '\033[0m'

def banner():
    print(f"""{C.M}
  ___              _     _
 | _ \___ _ _ ___ (_)___| |_ ___ _ _  __ ___
 |  _/ -_) '_(_-< | (_-<|  _/ -_) ' \/ _/ -_)
 |_| \___|_| /__/_|_/__/ \__\___|_||_\__\___|
              / __| |_  ___ __| |_____ _ _
             | (__| ' \/ -_) _| / / -_) '_|
              \___|_||_\___\__|_\_\___|_|
{C.E}{C.Y}Linux Persistence & Backdoor Detector{C.E}
""")

def run_cmd(cmd: str) -> str:
    try:
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=30)
        return result.stdout.strip()
    except:
        return ""

def check_startup_scripts() -> List[str]:
    """Check common startup script locations"""
    findings = []
    findings.append(f"{C.B}[Startup Scripts]{C.E}")

    locations = [
        '/etc/rc.local',
        '/etc/rc.d/rc.local',
        '/etc/init.d/',
        '/etc/profile',
        '/etc/profile.d/',
        '/etc/bash.bashrc',
        '/etc/bashrc',
        '/etc/environment',
    ]

    # User-specific
    home = os.path.expanduser('~')
    user_files = [
        f'{home}/.bashrc',
        f'{home}/.bash_profile',
        f'{home}/.profile',
        f'{home}/.zshrc',
        f'{home}/.config/autostart/',
    ]

    all_locations = locations + user_files

    for loc in all_locations:
        if os.path.exists(loc):
            if os.path.isfile(loc):
                try:
                    mtime = os.path.getmtime(loc)
                    size = os.path.getsize(loc)
                    findings.append(f"  {C.C}{loc}{C.E} (size: {size}b)")

                    # Check for suspicious content
                    with open(loc, 'r', errors='ignore') as f:
                        content = f.read()
                        suspicious = [
                            (r'nc\s+-', 'netcat reverse shell'),
                            (r'bash\s+-i', 'bash reverse shell'),
                            (r'/dev/tcp/', 'bash /dev/tcp'),
                            (r'curl.*\|.*sh', 'curl pipe to shell'),
                            (r'wget.*\|.*sh', 'wget pipe to shell'),
                            (r'python.*socket', 'python socket'),
                            (r'base64\s+-d', 'base64 decode'),
                            (r'eval.*base64', 'eval base64'),
                            (r'nohup.*&', 'nohup background'),
                            (r'0\.0\.0\.0|0<&', 'network redirection'),
                        ]
                        for pattern, desc in suspicious:
                            if re.search(pattern, content, re.IGNORECASE):
                                findings.append(f"    {C.R}[SUSPICIOUS]{C.E} Contains: {desc}")
                except:
                    pass
            elif os.path.isdir(loc):
                try:
                    files = os.listdir(loc)
                    findings.append(f"  {C.C}{loc}{C.E} ({len(files)} files)")
                except:
                    pass

    return findings

def check_systemd_services() -> List[str]:
    """Check systemd for persistence"""
    findings = []
    findings.append(f"{C.B}[Systemd Services]{C.E}")

    service_dirs = [
        '/etc/systemd/system/',
        '/usr/lib/systemd/system/',
        '/lib/systemd/system/',
        os.path.expanduser('~/.config/systemd/user/'),
    ]

    for sdir in service_dirs:
        if os.path.exists(sdir):
            try:
                for f in os.listdir(sdir):
                    if f.endswith('.service') or f.endswith('.timer'):
                        fp = os.path.join(sdir, f)
                        if os.path.isfile(fp):
                            # Check if enabled
                            enabled = run_cmd(f"systemctl is-enabled {f} 2>/dev/null")

                            try:
                                with open(fp, 'r') as sf:
                                    content = sf.read()
                                    # Check for suspicious exec commands
                                    if any(x in content.lower() for x in ['curl', 'wget', 'nc ', 'netcat', 'python', 'perl', 'ruby', '/tmp/', 'base64']):
                                        findings.append(f"  {C.R}[SUSPICIOUS]{C.E} {fp}")
                                        findings.append(f"    Status: {enabled}")
                                    elif enabled == 'enabled':
                                        findings.append(f"  {C.Y}{fp}{C.E} (enabled)")
                            except:
                                pass
            except:
                pass

    return findings

def check_cron_persistence() -> List[str]:
    """Check cron for persistence"""
    findings = []
    findings.append(f"{C.B}[Cron Persistence]{C.E}")

    cron_locations = [
        '/etc/crontab',
        '/etc/cron.d/',
        '/etc/cron.daily/',
        '/etc/cron.hourly/',
        '/etc/cron.weekly/',
        '/etc/cron.monthly/',
        '/var/spool/cron/',
        '/var/spool/cron/crontabs/',
    ]

    for loc in cron_locations:
        if os.path.exists(loc):
            if os.path.isfile(loc):
                try:
                    with open(loc, 'r') as f:
                        content = f.read()
                        for line in content.split('\n'):
                            if line and not line.startswith('#'):
                                suspicious = any(x in line.lower() for x in
                                    ['curl', 'wget', 'nc ', '/dev/tcp', 'python', 'perl', 'base64', '/tmp/'])
                                if suspicious:
                                    findings.append(f"  {C.R}[SUSPICIOUS]{C.E} {loc}")
                                    findings.append(f"    {line[:100]}")
                except:
                    pass
            elif os.path.isdir(loc):
                try:
                    for f in os.listdir(loc):
                        fp = os.path.join(loc, f)
                        if os.path.isfile(fp):
                            findings.append(f"  {C.C}{fp}{C.E}")
                except:
                    pass

    # Check user crontab
    user_cron = run_cmd("crontab -l 2>/dev/null")
    if user_cron:
        findings.append(f"  {C.C}User crontab:{C.E}")
        for line in user_cron.split('\n'):
            if line and not line.startswith('#'):
                findings.append(f"    {line[:80]}")

    return findings

def check_ssh_persistence() -> List[str]:
    """Check SSH for persistence"""
    findings = []
    findings.append(f"{C.B}[SSH Persistence]{C.E}")

    ssh_dirs = [
        os.path.expanduser('~/.ssh/'),
        '/root/.ssh/',
        '/etc/ssh/',
    ]

    for sdir in ssh_dirs:
        if os.path.exists(sdir):
            findings.append(f"  {C.C}{sdir}{C.E}")
            try:
                for f in os.listdir(sdir):
                    fp = os.path.join(sdir, f)
                    if os.path.isfile(fp):
                        mtime = os.path.getmtime(fp)
                        size = os.path.getsize(fp)

                        if f == 'authorized_keys':
                            try:
                                with open(fp, 'r') as af:
                                    keys = [l for l in af.readlines() if l.strip() and not l.startswith('#')]
                                    findings.append(f"    {C.Y}authorized_keys{C.E}: {len(keys)} keys")
                            except:
                                findings.append(f"    {f}")
                        elif f == 'sshd_config':
                            try:
                                with open(fp, 'r') as cf:
                                    content = cf.read()
                                    if 'PermitRootLogin yes' in content:
                                        findings.append(f"    {C.R}[WARN]{C.E} PermitRootLogin yes")
                                    if 'PasswordAuthentication yes' in content:
                                        findings.append(f"    {C.Y}[INFO]{C.E} PasswordAuthentication enabled")
                            except:
                                pass
                        else:
                            findings.append(f"    {f} ({size}b)")
            except:
                pass

    return findings

def check_at_jobs() -> List[str]:
    """Check at jobs"""
    findings = []
    findings.append(f"{C.B}[AT Jobs]{C.E}")

    at_output = run_cmd("atq 2>/dev/null")
    if at_output:
        findings.append(f"  {C.Y}Scheduled AT jobs:{C.E}")
        for line in at_output.split('\n'):
            findings.append(f"    {line}")
    else:
        findings.append(f"  No AT jobs scheduled")

    return findings

def check_ld_preload() -> List[str]:
    """Check LD_PRELOAD and ld.so.preload"""
    findings = []
    findings.append(f"{C.B}[LD_PRELOAD Persistence]{C.E}")

    # Check environment
    if os.environ.get('LD_PRELOAD'):
        findings.append(f"  {C.R}[CRITICAL]{C.E} LD_PRELOAD is set: {os.environ['LD_PRELOAD']}")

    # Check /etc/ld.so.preload
    if os.path.exists('/etc/ld.so.preload'):
        try:
            with open('/etc/ld.so.preload', 'r') as f:
                content = f.read().strip()
                if content:
                    findings.append(f"  {C.R}[CRITICAL]{C.E} /etc/ld.so.preload exists:")
                    findings.append(f"    {content}")
        except:
            pass

    # Check ld.so.conf.d
    if os.path.exists('/etc/ld.so.conf.d/'):
        for f in os.listdir('/etc/ld.so.conf.d/'):
            findings.append(f"  {C.C}/etc/ld.so.conf.d/{f}{C.E}")

    return findings

def check_kernel_modules() -> List[str]:
    """Check loaded kernel modules"""
    findings = []
    findings.append(f"{C.B}[Kernel Modules]{C.E}")

    # Get loaded modules
    modules = run_cmd("lsmod")
    if modules:
        # Known rootkit modules
        suspicious_mods = ['reptile', 'diamorphine', 'suterusu', 'bdvl', 'beurk', 'khook']

        for line in modules.split('\n')[1:]:  # Skip header
            parts = line.split()
            if parts:
                mod_name = parts[0].lower()
                if any(s in mod_name for s in suspicious_mods):
                    findings.append(f"  {C.R}[ROOTKIT?]{C.E} {line}")
                elif parts[0] not in ['Module']:
                    # Just count, don't list all
                    pass

        mod_count = len(modules.split('\n')) - 1
        findings.append(f"  Total modules loaded: {mod_count}")

    # Check for unsigned modules
    unsigned = run_cmd("grep -l 'intree' /sys/module/*/taint 2>/dev/null | wc -l")
    if unsigned:
        findings.append(f"  Out-of-tree modules: {unsigned}")

    return findings

def check_hidden_processes() -> List[str]:
    """Check for hidden processes"""
    findings = []
    findings.append(f"{C.B}[Hidden Processes]{C.E}")

    # Compare ps and /proc
    ps_pids = set(run_cmd("ps -eo pid --no-headers").split())
    proc_pids = set()

    if os.path.exists('/proc'):
        for entry in os.listdir('/proc'):
            if entry.isdigit():
                proc_pids.add(entry)

    hidden = proc_pids - ps_pids
    if hidden:
        findings.append(f"  {C.R}[SUSPICIOUS]{C.E} Processes in /proc but not in ps:")
        for pid in list(hidden)[:10]:
            try:
                cmdline = open(f'/proc/{pid}/cmdline', 'r').read().replace('\x00', ' ')
                findings.append(f"    PID {pid}: {cmdline[:60]}")
            except:
                findings.append(f"    PID {pid}: (unreadable)")
    else:
        findings.append(f"  {C.G}No hidden processes detected{C.E}")

    return findings

def check_network_backdoors() -> List[str]:
    """Check for network backdoors"""
    findings = []
    findings.append(f"{C.B}[Network Backdoors]{C.E}")

    # Listening ports
    listeners = run_cmd("ss -tlnp 2>/dev/null || netstat -tlnp 2>/dev/null")
    if listeners:
        findings.append(f"  {C.C}Listening TCP ports:{C.E}")
        for line in listeners.split('\n')[1:]:
            if 'LISTEN' in line:
                # Check for suspicious ports
                suspicious_ports = ['4444', '5555', '6666', '31337', '12345', '54321']
                is_suspicious = any(p in line for p in suspicious_ports)
                if is_suspicious:
                    findings.append(f"    {C.R}[SUSPICIOUS]{C.E} {line[:80]}")
                else:
                    findings.append(f"    {line[:80]}")

    # UDP listeners
    udp_listeners = run_cmd("ss -ulnp 2>/dev/null || netstat -ulnp 2>/dev/null")
    if udp_listeners and 'udp' in udp_listeners.lower():
        findings.append(f"\n  {C.C}Listening UDP ports:{C.E}")
        for line in udp_listeners.split('\n')[1:]:
            if line.strip():
                findings.append(f"    {line[:80]}")

    return findings

def main():
    parser = argparse.ArgumentParser(description='Linux Persistence Checker')
    parser.add_argument('-a', '--all', action='store_true', help='Run all checks')
    parser.add_argument('-s', '--startup', action='store_true', help='Check startup scripts')
    parser.add_argument('-S', '--systemd', action='store_true', help='Check systemd')
    parser.add_argument('-c', '--cron', action='store_true', help='Check cron')
    parser.add_argument('-k', '--ssh', action='store_true', help='Check SSH')
    parser.add_argument('-l', '--ldpreload', action='store_true', help='Check LD_PRELOAD')
    parser.add_argument('-m', '--modules', action='store_true', help='Check kernel modules')
    parser.add_argument('-p', '--processes', action='store_true', help='Check hidden processes')
    parser.add_argument('-n', '--network', action='store_true', help='Check network backdoors')
    args = parser.parse_args()

    banner()

    run_all = args.all or not any([args.startup, args.systemd, args.cron, args.ssh,
                                    args.ldpreload, args.modules, args.processes, args.network])

    if run_all or args.startup:
        for line in check_startup_scripts():
            print(line)
        print()

    if run_all or args.systemd:
        for line in check_systemd_services():
            print(line)
        print()

    if run_all or args.cron:
        for line in check_cron_persistence():
            print(line)
        print()

    if run_all or args.ssh:
        for line in check_ssh_persistence():
            print(line)
        print()

    if run_all:
        for line in check_at_jobs():
            print(line)
        print()

    if run_all or args.ldpreload:
        for line in check_ld_preload():
            print(line)
        print()

    if run_all or args.modules:
        for line in check_kernel_modules():
            print(line)
        print()

    if run_all or args.processes:
        for line in check_hidden_processes():
            print(line)
        print()

    if run_all or args.network:
        for line in check_network_backdoors():
            print(line)
        print()

    print(f"{C.G}[*] Persistence check complete.{C.E}")

if __name__ == '__main__':
    main()
