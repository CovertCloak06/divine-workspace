#!/bin/bash
# PKN Developer Command - One command for all dev tasks

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

show_help() {
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${CYAN}        PKN Developer Tools${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "${GREEN}Usage:${NC} ./dev <command>"
    echo ""
    echo -e "${YELLOW}Code Quality:${NC}"
    echo "  analyze       Run all code analysis checks"
    echo "  check         Quick validation (plugins, imports, etc.)"
    echo "  check-js      Scan for JavaScript errors"
    echo "  lint          Run biome linter"
    echo "  format        Auto-format code with biome"
    echo "  fix           Auto-fix common issues"
    echo ""
    echo -e "${YELLOW}Server:${NC}"
    echo "  start         Start PKN server"
    echo "  stop          Stop PKN server"
    echo "  restart       Restart PKN server"
    echo "  status        Check server status"
    echo "  logs          Tail server logs"
    echo ""
    echo -e "${YELLOW}Testing & Diagnostics:${NC}"
    echo "  test          Run all tests"
    echo "  test-plugins  Test plugin system"
    echo "  diagnose      Deep plugin diagnostics"
    echo "  doctor        Detailed health check"
    echo ""
    echo -e "${YELLOW}Maintenance:${NC}"
    echo "  clean         Clean build artifacts"
    echo ""
    echo -e "${YELLOW}Tools:${NC}"
    echo "  install       Install Chrome debugger extension"
    echo "  health        Quick health check"
    echo "  help          Show this help"
    echo ""
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

case "$1" in
    analyze)
        echo -e "${CYAN}Running comprehensive code analysis...${NC}"
        python3 "$SCRIPT_DIR/scripts/analyze_all.py"
        ;;

    check)
        echo -e "${CYAN}Running quick checks...${NC}"
        python3 "$SCRIPT_DIR/scripts/check_plugins.py"
        ;;

    lint)
        echo -e "${CYAN}Linting code with Biome...${NC}"
        cd "$SCRIPT_DIR/../.." && npx biome lint apps/pkn
        ;;

    format)
        echo -e "${CYAN}Formatting code with Biome...${NC}"
        cd "$SCRIPT_DIR/../.." && npx biome format --write apps/pkn
        ;;

    start)
        echo -e "${CYAN}Starting PKN server...${NC}"
        cd "$SCRIPT_DIR" && ./pkn_control.sh start-all
        ;;

    stop)
        echo -e "${CYAN}Stopping PKN server...${NC}"
        cd "$SCRIPT_DIR" && ./pkn_control.sh stop-all
        ;;

    restart)
        echo -e "${CYAN}Restarting PKN server...${NC}"
        cd "$SCRIPT_DIR" && ./pkn_control.sh stop-all && sleep 2 && ./pkn_control.sh start-all
        ;;

    status)
        cd "$SCRIPT_DIR" && ./pkn_control.sh status
        ;;

    logs)
        echo -e "${CYAN}Tailing logs (Ctrl+C to exit)...${NC}"
        tail -f "$SCRIPT_DIR/divinenode.log"
        ;;

    test)
        echo -e "${CYAN}Running tests...${NC}"
        bash "$SCRIPT_DIR/scripts/test_fixes.sh"
        ;;

    test-plugins)
        echo -e "${CYAN}Testing plugin system...${NC}"
        python3 "$SCRIPT_DIR/scripts/check_plugins.py"
        ;;

    check-js)
        echo -e "${CYAN}Scanning for JavaScript errors...${NC}"
        python3 "$SCRIPT_DIR/scripts/test/check_js_errors.py"
        ;;

    diagnose)
        echo -e "${CYAN}Running deep plugin diagnostics...${NC}"
        python3 "$SCRIPT_DIR/scripts/test/diagnose_plugins.py"
        ;;

    doctor)
        echo -e "${CYAN}Running detailed health check...${NC}"
        python3 "$SCRIPT_DIR/scripts/dev/pkn_health.py"
        ;;

    fix)
        echo -e "${CYAN}Auto-fixing common issues...${NC}"
        python3 "$SCRIPT_DIR/scripts/util/auto_fix.py"
        ;;

    clean)
        echo -e "${CYAN}Cleaning build artifacts...${NC}"
        python3 "$SCRIPT_DIR/scripts/build/clean_build.py"
        ;;

    install)
        echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${CYAN} Install Divine Debugger Chrome Extension${NC}"
        echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo ""
        echo "1. Open Chrome and go to: chrome://extensions/"
        echo "2. Enable 'Developer mode' (top right)"
        echo "3. Click 'Load unpacked'"
        echo "4. Select folder: $SCRIPT_DIR/../debugger-extension/"
        echo "5. Press F12 on any page and click 'Divine Debugger' tab"
        echo ""
        ;;

    health)
        echo -e "${CYAN}System Health Check${NC}"
        echo ""
        echo -e "${GREEN}Installed Tools:${NC}"
        echo -n "  pnpm: "
        pnpm --version 2>/dev/null || echo -e "${RED}Not installed${NC}"
        echo -n "  just: "
        just --version 2>/dev/null || echo -e "${RED}Not installed${NC}"
        echo -n "  pre-commit: "
        pre-commit --version 2>/dev/null || echo -e "${RED}Not installed${NC}"
        echo -n "  biome: "
        cd "$SCRIPT_DIR/../.." && npx biome --version 2>/dev/null || echo -e "${RED}Not installed${NC}"

        echo ""
        echo -e "${GREEN}Server Status:${NC}"
        if curl -s http://localhost:8010/health > /dev/null 2>&1; then
            echo -e "  ${GREEN}✓${NC} Server running on port 8010"
        else
            echo -e "  ${RED}✗${NC} Server not running"
        fi

        echo ""
        echo -e "${GREEN}Plugin Status:${NC}"
        PLUGIN_COUNT=$(ls -1d "$SCRIPT_DIR/plugins/"*/ 2>/dev/null | wc -l)
        echo "  $PLUGIN_COUNT plugins installed"
        ;;

    help|"")
        show_help
        ;;

    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
